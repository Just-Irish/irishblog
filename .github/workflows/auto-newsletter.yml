name: Auto-Send Newsletter on New Post

on:
  push:
    branches:
      - main
    paths:
      - 'content/posts/**/*.md'

jobs:
  send-newsletter:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Get changed files
        id: changed-files
        run: |
          # Get list of added markdown files in posts directory
          ADDED_FILES=$(git diff --name-only --diff-filter=A HEAD^ HEAD | grep '^posts/.*\.md$' || true)
          echo "Added files: $ADDED_FILES"
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$ADDED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Process new posts and send newsletter
        if: steps.changed-files.outputs.files != ''
        env:
          LISTMONK_URL: https://newsletter.insignificantgamer.blog
          LISTMONK_USERNAME: ${{ secrets.LISTMONK_USERNAME }}
          LISTMONK_PASSWORD: ${{ secrets.LISTMONK_PASSWORD }}
          BLOG_URL: https://insignificantgamer.blog
        run: |
          # Process each new markdown file
          echo "${{ steps.changed-files.outputs.files }}" | while read -r file; do
            if [ -z "$file" ]; then
              continue
            fi
            
            echo "Processing: $file"
            
            # Extract frontmatter and content
            TITLE=$(grep -m 1 '^title:' "$file" | sed 's/^title: *//; s/^"//; s/"$//')
            DATE=$(grep -m 1 '^date:' "$file" | sed 's/^date: *//')
            
            # Get post slug from filename
            SLUG=$(basename "$file" .md)
            POST_URL="${BLOG_URL}/posts/${SLUG}/"
            
            # Extract excerpt (first paragraph after frontmatter)
            EXCERPT=$(awk '/^---$/,/^---$/{next} NF{print; exit}' "$file" | head -c 200)
            
            echo "Title: $TITLE"
            echo "URL: $POST_URL"
            
            # Create HTML email body
            BODY="<h2><a href=\"${POST_URL}\">${TITLE}</a></h2>
            <p>${EXCERPT}...</p>
            <p><a href=\"${POST_URL}\">Read the full post on Insignificant Gamer</a></p>
            <hr>
            <p><small>You're receiving this because you subscribed to Insignificant Gamer newsletter.</small></p>"
            
            # Create campaign in Listmonk
            CAMPAIGN_JSON=$(cat <<EOF
          {
            "name": "New Post: ${TITLE}",
            "subject": "New Post: ${TITLE}",
            "lists": [3],
            "type": "regular",
            "content_type": "html",
            "body": $(echo "$BODY" | jq -Rs .),
            "send_at": null,
            "messenger": "email"
          }
          EOF
            )
            
            echo "Creating campaign..."
            CAMPAIGN_RESPONSE=$(curl -s -u "${LISTMONK_USERNAME}:${LISTMONK_PASSWORD}" \
              -X POST \
              -H "Content-Type: application/json" \
              -d "$CAMPAIGN_JSON" \
              "${LISTMONK_URL}/api/campaigns")
            
            CAMPAIGN_ID=$(echo "$CAMPAIGN_RESPONSE" | jq -r '.data.id')
            
            if [ "$CAMPAIGN_ID" != "null" ] && [ -n "$CAMPAIGN_ID" ]; then
              echo "Campaign created with ID: $CAMPAIGN_ID"
              
              # Start the campaign (send immediately)
              echo "Sending campaign..."
              curl -s -u "${LISTMONK_USERNAME}:${LISTMONK_PASSWORD}" \
                -X PUT \
                "${LISTMONK_URL}/api/campaigns/${CAMPAIGN_ID}/status" \
                -H "Content-Type: application/json" \
                -d '{"status": "running"}'
              
              echo "✅ Newsletter sent for: $TITLE"
            else
              echo "❌ Failed to create campaign"
              echo "Response: $CAMPAIGN_RESPONSE"
              exit 1
            fi
          done
